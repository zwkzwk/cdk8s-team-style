# Kettle 安装和配置

- 基于 JDK8
- 现在改名为：PDI = pentaho data integration
    - 20210118 最新版本为：Pentaho 9.1
- 官网帮助文档：<https://github.com/pentaho/pentaho-kettle>
- 官网下载：<https://sourceforge.net/projects/pentaho/files/>
- 国内老版本下载：<http://mirror.bit.edu.cn/pentaho/>

## 核心概念

- Spoon：图形化设计工具
    - Job 作业：完成整个工作流的控制
    - Transformation 转换：完成针对数据的基础转换
- Pan：用于执行由的 Transformation
- Kitchen：用于执行由的 Job
- Data Integration Server
    - 执行作业、转换
    - 提供用户、角色、内容管理

## 解压安装方式

- 解压后的目录结构介绍
classes：生命周期监听，注册表扩展，日志的配置文件
Data Integration.app：数据集成应用
Data Service JDBC Driver：数据库驱动程序
docs：文档
launcher:启动配置
lib:支持jar
libswt:图形界面
plugins：插件
pwd：集群配置文件
samples：自带例子
simple-jndi：jndi连接
system：系统目录
ui：软件界面


carte.sh 启动集群命令
encr.sh kettle加密算法
import.sh 导入命令
kitchen.sh 运行 Job 命令
pan.sh 运行 Transformation 的命令
set-pentaho-env.sh 设置环境变量命令
spoon.sh 界面运行（重要，首次打开、使用会很慢。最好可以编辑这个脚本，找到 JVM 值，改为更大的 Xms Xmx）
spoonConsole.sh 以控制台的形式运行 spoon





配置环境变量：
KETTLE_HOME > 指向解压后的根目录
我这边使用 MySQL8，所以我这边使用：mysql-connector-java-8.0.21.jar
将下载好的mysql的驱动放到kettle安装文件中的lib下面，然后重启Spoon
自定义驱动类名称填入：com.mysql.cj.jdbc.Driver


## 把作业、转换存储到 MySQL 中

- 点击右上角：Connect
- 选择小字眼的 other Repositories
- 选择 Database Repository
    - Display name：建议填写数据库名，方便对应
    - Database Connection：配置数据库连接
        - Create New Connection

## 知识点


CSV
excel
JSON

文件合并
从JSON获取数据

表输入：需要将对应数据库驱动放在data-integration\lib中
注意如果配置的是mysql的话，Use Result Streaming Cursor选项是解决数据过大，内存不足问题，启用后这样不需要把所有的数据都读取到内存中

EXCEL 输出
注意如果勾选Stream XSLX data ，则速度加快

SQL输出
如果需要把表结构也导出，请勾选不存在则创建表

表输出
需要指定数据库字段才能获取字段

更新
更新就是把数据库中已经存在的记录于数据流里的记录进行比对，如果不同则更新

注意，如果记录不存在则会出现错误
1.先设置忽略查询字段(防止错误)
2.设置用来查询的关键字例如id=id
3.设置需要更新字段

插入更新[重要]
插入更新就是把数据库已经存在的记录与数据流里的记录进行比对，如果不同就进行更新。【如果记录不存在则会进行插入数据】

如果某个字段不想更新则设置为N,否则为Y
如果只想进行增量操作，则需要勾选不执行任何更新
删除
删除就是删除数据库中的值，需要指定数据库连接和数据表 然后指定查询关键字，表字段，比较符号，流里的字段等例如id=id

Conncat fields
多个字段连接形成一个新的字段，需要设置目标字段，字段1，字段2，和连接符

值映射
把字段映射成其他的值，例如性别在不同系统中用不同的字段表示，代表的值也不同，我们可以使用值映射来统一性别的字段表示。

分别设置源字段和目标字段和值映射

增加常量
增加常量就是在本身的数据流里面添加一列数据，该列数据都是相同的值

增加序列
给数据流添加一个序列字段

数据库来生成序列：只有oracle支持
转换计数器来生成：设置起始值，步长，最大值

字段选择
字段选择是从数据流中选择字段、修改名称、修改数据类型

选择和修改选项卡中修改字段名称
移除选项卡中丢弃某些字段
元数据选项卡中可以修改字段的名称和数据类型
计算器
一个函数集合来创建新的字段，还可以设置字段是否移除(临时字段)

字符串剪切、替换、操作
剪切字符串是指定输入流字段裁剪的位置剪切出新的字段
字符串替换是指定搜索内容和替换内容，如果输入流的字段匹配上搜索内容就进行替换生成信息的字段
字符串操作时去除字符串两端的空格和大小写切换，并生成新的字段
拆分字段
会把字段拆分，拆分后原有字段会消失

拆分为多行
就是把指定分隔符的字段进行拆分拆分为多行

排序+去除重复记录
去除重复记录之前必须先排序，

唯一行(哈希值)
唯一行就是删除数据流重复的行，效果和排序+去除重复记录一样，但实现原理不同，他的执行效率会高一点。

列转行【重要】
就是如果数据一列有相同的值，按照指定的字段把多行数据转换为一行数据，去除一些原来的列名，把一列数据变为字段。

注意：列转行之前数据流必须进行排序

指明关键字段：把这一列的内容转换为新的列名

分组字段：生成后的字段如何分组

目标字段：生成后的字段

数据字段：目标字段的查找对象，

关键字值：查找数据字段

行转列【重要】
把行数据转为列数据，需要给每一列数据修改为统一字段。

行扁平化
把同一组的多行数据合并成为一行，注意和行转列区别

注意：只有数据流的同类型数据行记录记录一致的情况才可以使用！数据流必须进行排序，否则结果不正确。

替换空值
将null替换为指定的值

写日志
指定日志级别，要输出的信息，要打印的日志

switchcase
让数据流从一路到多路

制定switch 字段 指定case值类型，case 值和对应目标，默认目标

过滤记录
让数据流从一路到两路，类似程序中的if条件。但是数据流会根据指定条件来分流。

空操作
什么也不做，只有名称

中止
是数据流的终点，如果数据流到这，将会报错直接中止。例如过滤记录的fase条件对应的是该控件，一旦有数据不满足就会中止当前程序操作。

HttpClient
会使用get方式提交请求获取返回的页面内容。

直接设置url或者从字段中获取 ，设置编码，连接超时设置等，输出结果的字段名

数据库查询
数据库查询就是数据库里面的【左连接】

指定数据库连接，表名，指定条件，输出字段

数据库连接
可以执行两个数据的查询，和【单参数】的表输入。

设置数据库连接，书写sql 参数用？替代，下方设置具体的参数字段。

流查询
流查询在查询前把数据都加载到内存种，并且只能进行等值查询。例如将两个来源的数据进行关联之后进行输出。

需要输入步骤，查询所需的关键字，用来接收的字段。

合并记录
合并记录将两个不同来源的数据合并，这两个来源的数据分为旧数据和新数据，该步骤将旧数据和新数据按照指定的关键子 匹配、比较、合并。

标志字段：设置标志字段的名称，标志字段用于保存比较的结果，比较结果有下列几种

identical 旧数据和新数据一样
changed – 数据发生了变化
new 新数据有而旧数据种没有的记录
deleted 旧数据有而新数据种没有的记录
关键字段：用于定位两个数据源种的同一条记录

数据(比较)字段：对于两个数据源种的同一条记录种指定需要比较的字段

合并后将包含旧数据来源和新数据来源的所有数据，对于比那花的数据，使用新数据代替旧数据，同时在结果里面用一个标识字段，来指定新旧数据的比较结果。

注意：旧数据和新数据实现要按照关键字段排序、

旧数据和新数据要有相同字段的名称

记录关联(笛卡尔积)
对两个数据进行笛卡尔积

一定要指定主步骤

记录集连接
记录集连接就想数据库的左连接、右链接、内连接、外连接一样

指定第一个步骤，第二个步骤，需要分别指定这两个步骤的连接的字段，然后指定关联模式

分组
按照一个或者几个进行分组，同时将其余字段按照某种规则进行合并。

注意：分组之前数据应该进行排序。

指定分组的字段，设置聚合字段，聚合主题，聚合类型等

映射【重要】
映射(子转换)是用来配置子转换，对【子转换调用的】一个步骤

映射输入规范是输入字段，由调用的转换进行输入。需要定义好需要输入的字段，名称，字段，类型等

映射输出规范是向调用的转换【输出所有列】，只需要输入名称即可

注意：映射和子转换是写在不同的文件中的。用来切分过多步骤造成的维护难度。

javascript 脚本【重要】
可以直接书写脚本，字段可以直接赋值给临时变量。非常灵活

Java脚本
main函数对应一个processRow()函数 是用来处理数据流的场所

SQL 脚本
书写sql语句，如果需要传参，使用？同时勾选”执行每一行“，同时指定作为参数的字段

作业【重要】
转换以并行的方式执行，需要串行执行的作业来处理这些操作。

一个作业包含一个或者很多作业项，这些作业想以某种顺序来执行。作业执行顺序由作业项之间的跳 和每个作业项的执行结果来决定。

作业项
作业项是作业的基本构成部分。以图标的方式图形化展示。作业项之间可以传递结构对象，这个结果对象里包含了数据行，它不是以数据流的方式来传递，而是【等待一个作业项执行完了，再传递下一个作业项】

作业跳
作业之间的连线就是作业的跳。标识作业的执行路径，分为两种情况

无条件执行:不管上一个作业项执行情况如何，一定执行，【蓝色连线，有锁的图标】
执行结果为真执行：上一个作业项必须执行结果为真，【绿色连线，上面有一个对勾号】

执行结果为真执行：上一个作业项必须执行结果为真，【红色连线，上面有一个停止号】
全局参数【重要】
通过当前用户下.kettle文件夹中的kettle。properties文件来定义的使用【键=值】形式，配置完需要重启。

局部参数【重要】
通过”Set Variables” 和”Get Variables“来设置

“Set Variables” 设置时再当前转换中不能立马使用，需要再作业中的下一步骤中使用

使用方式：一种%%变量名%%，一种是${变量名}

注意：在SQL使用变量时需要把”是否替换变量“勾选上，否则变量无法生效

常量传递
先自定义常量车速据，在表输入的SQL语句里面使用？来进行替换。？号的替换顺序就是常量定义的顺序。

转换命名参数(转换内部变量)
转换命名参数就时在转换内部定义的变量，作用范围时在转换内部。在转换(操作界面)空白处右键，选择转换设置就可以看见

发送邮件
收件人地址、抄送，发件人回复名称、地址（必须是企业邮箱），服务器（SMTP服务器地址和端口），授权信息（发件人用户名和密码或使用SSL）,主题和内容，附件。







## 资料

- <>





